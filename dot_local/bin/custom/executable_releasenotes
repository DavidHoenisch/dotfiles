#!/usr/bin/env python3
import subprocess
import re
from datetime import datetime

def run_git_command(command):
    """Run a git command and return its output."""
    try:
        result = subprocess.run(command, capture_output=True, text=True, check=True)
        return result.stdout.strip()
    except subprocess.CalledProcessError as e:
        print(f"Error running git command: {e}")
        return None

def get_current_commit():
    """Get the hash of the current commit."""
    return run_git_command(['git', 'rev-parse', 'HEAD'])

def get_tags():
    """Get all tags in the repository, sorted by creation date."""
    tags = run_git_command(['git', 'tag', '--sort=-creatordate'])
    if not tags:
        return []
    return tags.split('\n')

def get_commit_date(commit):
    """Get the date of a specific commit."""
    date_str = run_git_command(['git', 'show', '-s', '--format=%ci', commit])
    if date_str:
        return datetime.strptime(date_str.split(' ')[0], '%Y-%m-%d')
    return None

def get_commit_message(commit):
    """Get the commit message for a specific commit."""
    return run_git_command(['git', 'log', '-1', '--pretty=%B', commit])

def get_changes_between_commits(from_commit, to_commit):
    """Get the log of changes between two commits."""
    log = run_git_command(['git', 'log', '--pretty=%h %s (%an, %ad)', '--date=short', f'{from_commit}..{to_commit}'])
    return log.split('\n') if log else []

def get_commit_for_tag(tag):
    """Get the commit hash for a specific tag."""
    return run_git_command(['git', 'rev-list', '-1', tag])

def generate_markdown_summary():
    """Generate a Markdown summary of changes from current commit to previous tag."""
    # Get current commit
    current_commit = get_current_commit()
    if not current_commit:
        return "# Changelog\n\nNo current commit found."

    # Get all tags
    tags = get_tags()
    if not tags:
        return "# Changelog\n\nNo tags found in the repository."

    # Get current tag (if HEAD is tagged)
    current_tag = run_git_command(['git', 'describe', '--tags', 'HEAD'])
    if not current_tag:
        current_tag = current_commit[:7]  # Use short commit hash if no tag

    # Find the previous tag
    if len(tags) < 2:
        previous_tag = None
    else:
        current_tag_index = tags.index(current_tag) if current_tag in tags else -1
        previous_tag = tags[0] if current_tag_index == -1 else tags[current_tag_index + 1] if current_tag_index + 1 < len(tags) else None

    # Generate changelog
    markdown = f"# Changelog\n\n## {current_tag} ({datetime.now().strftime('%Y-%m-%d')})\n\n"

    if not previous_tag:
        markdown += "No previous tag found. Showing all changes from the initial commit.\n\n"
        changes = get_changes_between_commits('', current_commit)
    else:
        previous_commit = get_commit_for_tag(previous_tag)
        if not previous_commit:
            return "# Changelog\n\nError retrieving commit for previous tag."
        markdown += f"Changes since {previous_tag}:\n\n"
        changes = get_changes_between_commits(previous_commit, current_commit)

    if not changes:
        markdown += "No changes found.\n"
    else:
        for change in changes:
            if change.strip():
                markdown += f"- {change}\n"

    return markdown

def main():
    """Main function to generate and print the changelog."""
    print(generate_markdown_summary())

if __name__ == "__main__":
    main()
